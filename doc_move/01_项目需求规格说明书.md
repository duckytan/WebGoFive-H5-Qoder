# 01 - 项目需求规格说明书

> **版本**: v1.2.0  
> **目标**: 定义H5五子棋项目的完整功能需求、技术要求与验收标准，确保AI能够据此完全复刻产品

---

## 1. 产品概述

| 项目名称 | H5五子棋 (Gomoku H5) |
|----------|----------------------|
| 产品类型 | 浏览器棋类游戏 |
| 技术栈 | HTML5 + CSS3 + JavaScript (ES6+) |
| 部署方式 | 静态托管 (如 GitHub Pages)，完全离线可用 |
| 目标用户 | 喜爱五子棋的玩家、学习VCF的棋友、教学演示场景 |

### 1.1 核心目标

1. 提供完整、规则正确的五子棋体验
2. 支持多种游戏模式（PvP / PvE / EvE / VCF练习）
3. 内置4级AI难度，涵盖从新手到地狱级别
4. 支持棋局保存、加载、回放等进阶功能
5. 提供木质棋盘风格和现代UI交互体验

### 1.2 非目标
- 不包含在线对战及后台服务器
- 不依赖任何第三方前端框架或构建工具
- 不支持IE浏览器

---

## 2. 功能需求

### 2.1 棋盘与棋子

| 编号 | 需求 | 说明 |
|------|------|------|
| FR-BOARD-01 | 棋盘尺寸 | 15×15交叉点，合计225个落子位 |
| FR-BOARD-02 | 棋子样式 | 黑白圆形棋子，支持光泽和阴影 |
| FR-BOARD-03 | 天元标记 | 棋盘中央(7,7)需要特殊标记 |
| FR-BOARD-04 | 坐标系统 | 可选显示A-O & 1-15坐标（默认隐藏，可在设置中开启） |
| FR-BOARD-05 | 交互方式 | 鼠标点击/触摸落子，悬停显示预览 |

### 2.2 游戏模式

| 模式 | 描述 | 特性 |
|------|------|------|
| PvP | 双人本地对战 | 黑棋先手轮流落子，支持悔棋 |
| PvE | 人机对战 | 玩家固定执黑，AI执白，4级难度任选 |
| EvE | 机机对战 | 黑白双方均由AI控制，可选择不同难度组合，在UI上仅观战 |
| VCF练习 | 冲四练习 | 从题库加载局面，玩家按题解走子，AI自动防守，包含进度追踪 |

### 2.3 租用功能（操作与控制）

| 功能 | 说明 |
|------|------|
| 新游戏 | 重置棋盘与状态，保留设置 |
| 悔棋 | 撤销最近一次落子（对PvP/PvE/EvE有效，VCF模式禁用） |
| 模式切换 | 按钮循环 PvE → PvP → EvE → VCF → ...，切换时自动重置棋盘 |
| AI提示 | 在PvE/PvP模式下可请求AI建议，提示位以高亮显示，3秒冷却 |
| 存档管理 | 保存当前棋局为JSON文件，支持导入恢复 |
| 棋局回放 | 以音乐播放器风格回放历史步骤，支持播放/暂停/跳转/导出 |
| 设置面板 | 控制坐标显示、风险提示、音效、动画等开关 |
| 帮助面板 | 提供规则说明、禁手示例、快捷键、VCF教程 |

### 2.4 VCF练习专属需求

| 编号 | 需求 |
|------|------|
| FR-VCF-01 | 题库包含40道题，分4个难度等级，每级10题 |
| FR-VCF-02 | 每道题包含标题、描述、难度、最少步数、最高允许步数、关键提示 |
| FR-VCF-03 | 玩家每走一步都需验证正确性，错步提示正确坐标并要求重试 |
| FR-VCF-04 | AI防守固定为地狱难度，防守落子有400ms延迟 |
| FR-VCF-05 | 记录玩家完成时间、进度（localStorage键：`vcf_practice_progress_v3`） |
| FR-VCF-06 | 提供重新练习 / 下一题 按钮，以及难度选择器 |

### 2.5 数据持久化

| 功能 | 说明 |
|------|------|
| 自动保存 | 默认开启，保存当前棋局到localStorage，每30秒自动触发 |
| 手动保存 | 导出JSON文件，包含棋盘、历史、模式、难度、设置等 |
| 加载棋局 | 导入JSON文件，验证版本(支持1.0.0~1.1.0)，恢复状态且同步渲染 |
| 回放数据 | 支持从存档中读取move列表进行回放 |

---

## 3. 游戏规则需求

### 3.1 基本规则

| 规则 | 说明 |
|------|------|
| 先手 | 黑棋先手，白棋后手 |
| 落子 | 轮流在空白交叉点落子，落子后不可更改（除悔棋外） |
| 胜负判定 | 任意方向（横/竖/斜）连续5子视为获胜（优先级高于禁手） |
| 平局 | 当棋盘填满且无人获胜视为平局 |
| 悔棋 | 必须按时间逆序撤销，撤回一步意味着撤去最近一次有效落子 |

### 3.2 禁手规则（仅对黑棋生效）

| 规则 | 定义 | 判定方法（参考代码） |
|------|------|--------------------|
| 三三禁手 | 一步棋同时形成两个“活三” | `game-core.js → countOpenThrees()` + `countOpenThreesInLine()` |
| 四四禁手 | 一步棋同时形成两个“四”（活四/冲四/眠四） | `countOpenFours()` + `countOpenFoursInLine()` |
| 长连禁手 | 一步棋形成六子或以上连线 | `checkLongLine()` |

**活三形态**：`_●●●_`, `_●●_●_`, `_●_●●_`（边界视为阻断）  
**活四形态**：`_●●●●_`  
**冲四形态**：`●●●●_`, `_●●●●`, `●●_●●`

禁手检测流程：
1. 在目标坐标临时落子
2. 执行长连检测
3. 统计活三和活四数量
4. 一旦满足禁手条件立即返回
5. 恢复棋盘

### 3.3 AI移动优先级（HELL难度示例）

1. 立即获胜点（`findWinningMove`）
2. 阻挡对手获胜点
3. VCF连续冲四攻击
4. 改进VCF防守 (`searchVCFDefense`)
5. 双三/双四等致命威胁防守
6. 活三防守 (`findOpenThreeDefense`)
7. Alpha-Beta搜索（深度3+）

---

## 4. 用户界面需求

### 4.1 布局

| 区块 | 内容 |
|------|------|
| 标题栏 | 项目名称、版本徽章、全局按钮（提示/设置/帮助） |
| 左侧面板 | 当前玩家、游戏状态、控制按钮、AI设置、VCF面板 |
| 中央棋盘 | Canvas棋盘、坐标标识、提示信息、回放控制器 |
| 模态框 | 设置、帮助、游戏结果、回放详情等 |

### 4.2 视觉风格
- 木质背景，暖色调（`--board-wood-*`）
- 棋子具有光泽与阴影（使用radial-gradient模拟）
- 控件使用柔和圆角和阴影
- AI状态和提示使用颜色区分（蓝/绿/橙/红）

### 4.3 响应式要求
- 在≥1024px屏幕显示双列布局
- 在移动端（≤768px）切换为上下布局，棋盘保持居中
- 所有按钮可触摸操作（最小可点击区域44px）

### 4.4 交互反馈
- 悬停棋位显示半透明预览
- 禁手位置使用红色高亮和文字提示
- AI思考时显示“思考中”动画和禁用按钮
- 模式切换后更新模式文本和提示

---

## 5. 技术要求

### 5.1 核心技术
- HTML5 Canvas 2D API（绘制棋盘和棋子）
- 原生JavaScript ES6+（class、let/const、模板字符串等）
- CSS3（变量、Flexbox、Grid、动画）
- LocalStorage（存档、设置、VCF进度）

### 5.2 模块化要求
- 所有模块必须输出到window全局对象
- 实例创建顺序：`GameUtils → GomokuGame → AdvancedAI → SimpleBoardRenderer → GameSaveLoad → GameReplay → VCFPracticeManager → InterfaceDemo`
- 模块通过`__moduleInfo`标记版本和依赖信息

### 5.3 兼容性
- 桌面端：Chrome 60+ / Firefox 55+ / Safari 12+ / Edge 79+
- 移动端：iOS Safari 11+ / Android Chrome 60+
- 不支持IE和旧版浏览器
- 需支持Retina屏幕（Canvas高分辨率渲染）

### 5.4 性能指标

| 指标 | 目标 |
|------|------|
| 首屏加载 | < 3秒（HTTP服务器环境） |
| Canvas渲染 | 60 FPS（一般局面） |
| AI思考时间 | BEGINNER <0.5s, NORMAL <1s, HARD <2s, HELL <3s |
| 内存占用 | < 50MB |
| 文件体积 | 总资源 < 5MB |

---

## 6. 非功能需求

### 6.1 可维护性
- 代码遵循ESLint推荐规则（no-eval、no-undef等）
- 重要函数必须包含参数校验和错误日志
- 关键模块提供JSDoc注释

### 6.2 可扩展性
- AI难度可扩展（新增算法模块）
- 练习模式可扩展（支持VCT/自定义题库）
- UI支持主题切换（样式定义使用CSS变量）

### 6.3 可用性
- 全部按钮和状态文本必须中文友好提示
- 禁手/错误操作提供明确提示
- 提示系统支持多语言拓展（通过常量配置）

### 6.4 安全性
- 文件导入仅接受JSON，并进行结构验证
- LocalStorage操作包含错误捕获，避免阻塞
- 不执行任何用户提供的代码

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 完整实现四大模式并可切换
- [ ] 禁手检测结果正确（覆盖各种棋形）
- [ ] AI各难度可选且行为符合预期
- [ ] 存档/加载/回放流程无错误
- [ ] VCF练习题可自由切换，进度可保存

### 7.2 性能验收
- [ ] 在Chrome 60+运行无明显卡顿
- [ ] AI响应时间符合设定
- [ ] Canvas渲染保持流畅（无闪烁）
- [ ] 自动保存不会造成UI卡顿

### 7.3 用户体验验收
- [ ] 所有按钮有点击反馈
- [ ] 信息提示清晰，错误描述友好
- [ ] 移动端布局可用
- [ ] 配色与字体保持一致风格

### 7.4 兼容性验收
- [ ] Chrome最新稳定版
- [ ] Safari (桌面和移动)
- [ ] Firefox (桌面)
- [ ] Edge (Chromium)

---

## 8. 风险与约束

| 风险 | 影响 | 对策 |
|------|------|------|
| Canvas尺寸与样式不匹配 | 棋盘模糊或点击偏移 | 初始化时计算devicePixelRatio并设置canvas大小 |
| 模块加载顺序出错 | 全局对象未定义导致崩溃 | 严格控制script标签顺序，提供依赖检查工具（ModuleDependencyChecker） |
| AI搜索耗时过长 | 影响体验 | 在demo.js中限制思考时间，必要时降级算法 |
| 存档兼容性 | 旧版本文件无法加载 | `GameSaveLoad`提供版本判断和错误提示 |
| LocalStorage写入失败 | 无法保存进度 | 捕获异常并提示用户检查浏览器设置 |

---

## 9. 里程碑与优先级

| 里程碑 | 内容 | 优先级 |
|--------|------|--------|
| M1 - 核心规则 | 棋盘绘制、落子、胜负/禁手判定、PvP模式 | P0 |
| M2 - AI系统 | PvE & EvE模式、AI难度切换、AI提示 | P0 |
| M3 - 存档回放 | 保存/加载、回放播放器 | P1 |
| M4 - VCF练习 | 题库、验证、进度、UI集成 | P1 |
| M5 - UX优化 | 动画、音效、设置、帮助、移动端适配 | P2 |
| M6 - 扩展功能 | 高级AI算法、更多题库、统计等 | P3 |

---

## 10. 参考资料

- 原始文档：`docs/requirements/需求规格书.md`
- 设计文档：`docs/design/五子棋规则与算法.md`, `docs/design/AI难度等级设计.md`
- 实现代码：`js/game-core.js`, `js/ai-advanced.js`, `js/vcf-practice.js`
- VCF实践总结：`VCF_PRACTICE_SUMMARY.md`

---

**下一步推荐阅读**: [02_技术架构设计文档.md](./02_技术架构设计文档.md)
