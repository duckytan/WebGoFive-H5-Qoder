# 09 - 常见问题与解决方案 (FAQ)

> **目的**: 快速定位和解决开发/运行中的常见问题

---

## 1. 模块加载相关

### Q1: 控制台提示 `GomokuGame is not defined`
**原因**: 脚本加载顺序错误或文件路径不对
**解决**:
1. 确保`index.html`中脚本按以下顺序引入：
```html
<script src="js/utils.js"></script>
<script src="js/game-core.js"></script>
<script src="js/ai-advanced.js"></script>
<script src="js/board-renderer.js"></script>
<script src="js/game-save-load.js"></script>
<script src="js/game-replay.js"></script>
<script src="js/vcf-practice.js"></script>
<script src="js/demo.js"></script>
```
2. 检查文件是否存在，路径是否正确（使用相对路径）

### Q2: `ModuleDependencyChecker` 报警告
**原因**: 依赖模块未加载或命名不一致
**解决**:
- 确认模块通过 `window.ModuleName = ModuleName` 导出
- 检查 `__moduleInfo` 的 name 与实际一致
- 在Console执行 `window.ModuleDependencyChecker.logModuleInfo()` 查看加载情况

---

## 2. 棋盘/渲染问题

### Q3: Canvas显示模糊
**可能原因**:
- Retina屏未处理
- Canvas尺寸与CSS尺寸不一致
**解决**:
```javascript
const dpr = window.devicePixelRatio || 1;
canvas.width = canvasWidth * dpr;
canvas.height = canvasHeight * dpr;
ctx.scale(dpr, dpr);
```

### Q4: 点击落子偏移
**原因**: Canvas定位或缩放导致坐标计算错误
**解决**:
```javascript
const rect = canvas.getBoundingClientRect();
const x = e.clientX - rect.left;
const y = e.clientY - rect.top;
const gridX = Math.round((x - padding) / cellSize);
const gridY = Math.round((y - padding) / cellSize);
```

---

## 3. 禁手与规则

### Q5: 黑棋无法在某些位置落子
**可能原因**: 触发禁手
**定位**:
- 控制台输出 `result.forbiddenType`
- 使用`GameDebug.checkForbidden(x, y)`查看详情
**解决**:
- 参考 `docs/design/五子棋规则与算法.md` 确认局面是否符合禁手
- 如果为假阳性，检查 `countOpenThrees` / `countOpenFours` 的逻辑

### Q6: 五连却被判禁手
**情况**: 黑棋落子形成五连同时构成禁手
**正确行为**: 五连优先，应该判胜
**检查**:
- 确保 `checkWin` 在 `checkForbidden` 之前或胜利判定优先执行

---

## 4. AI问题

### Q7: AI不响应或过长时间无动作
**原因**:
- `aiThinking` 状态没有重置
- AI陷入异常（如无限递归）
- 高难度VCF搜索耗时过长
**解决**:
```javascript
// 1. 确保AI执行完毕后重置状态
this.aiThinking = false;
clearTimeout(this.aiTimer);

// 2. 添加超时保护
const thinkTimeout = setTimeout(() => {
    console.warn('AI超时，降级策略');
    this.executeFallbackMove();
}, MAX_AI_THINK_TIME);
```

### Q8: AI频繁下错棋
**可能原因**:
- 评分表设置不合理
- 候选点选择过少
- 没有考虑对手威胁
**解决**:
- 调整 `aiScoreTable`
- 增加 `candidateLimit`
- 增加防守权重

---

## 5. 存档/加载

### Q9: 加载棋局时报错 `不兼容的文件版本`
**原因**: 文件version字段不在支持列表
**解决**:
- 确认`gameData.version`在 `['1.0.0','1.0.1','1.1.0']`
- 如需加载旧版本，更新 `isCompatibleVersion`

### Q10: 加载后棋盘与界面不同步
**原因**: 加载后未刷新渲染器或UI
**解决**:
```javascript
window.game.loadFromData(gameData);
window.boardRenderer.board = window.game.getBoardState();
window.boardRenderer.render();
demo.restoreUI(gameData);
```

---

## 6. 回放系统

### Q11: 回放进度条不动
**原因**: 未在播放过程中更新UI
**解决**:
```javascript
updateProgress(step) {
    const progress = (step / (this.totalSteps - 1)) * 100;
    this.progressSlider.value = progress;
    this.progressFill.style.width = `${progress}%`;
}
```

### Q12: 回放播放/暂停按钮图标不切换
**解决**:
```javascript
togglePlayPause() {
    this.isPlaying = !this.isPlaying;
    document.getElementById('replay-play-icon').textContent = this.isPlaying ? '⏸️' : '▶️';
}
```

---

## 7. VCF练习

### Q13: VCF模式无法落子
**原因**: 未调用 `demo.handleVCFPracticeMove`
**解决**:
```javascript
// 在board-renderer的placePiece中
if (window.demo?.gameMode === 'VCF_PRACTICE') {
    window.demo.handleVCFPracticeMove(x, y);
    return;
}
```

### Q14: VCF进度不保存
**原因**: LocalStorage操作失败或未调用保存方法
**解决**:
```javascript
saveProgress() {
    try {
        localStorage.setItem('vcf_practice_progress_v3', JSON.stringify(this.progress));
    } catch (error) {
        console.error('保存进度失败:', error);
    }
}
```

---

## 8. UI与交互

### Q15: 模式切换按钮多次点击导致状态错乱
**原因**: 切换过程未禁用按钮
**解决**:
```javascript
async toggleGameMode() {
    this.isSwitchingMode = true;
    document.getElementById('mode-toggle-btn').disabled = true;
    
    await this.startNewGame(nextMode);
    
    this.isSwitchingMode = false;
    document.getElementById('mode-toggle-btn').disabled = false;
}
```

### Q16: 提示按钮被频繁点击
**解决**:
```javascript
const cooldown = 3000;
if (Date.now() - this.lastHintTime < cooldown) {
    const remaining = Math.ceil((cooldown - (Date.now() - this.lastHintTime)) / 1000);
    this.updateHintMessage(`提示冷却中（${remaining}秒）`, 'warning');
    return;
}
```

---

## 9. 部署问题

### Q17: GitHub Pages 404
**解决**:
- 确认Pages配置正确
- 添加`.nojekyll`
- 确保所有路径为相对路径

### Q18: 本地直接打开index.html无法加载存档
**原因**: file://协议限制FileReader或LocalStorage
**解决**: 使用HTTP服务器 (python -m http.server)

---

## 10. 调试技巧

```javascript
// 启用调试
window.GameDebug = {
    board: () => console.table(game.getBoardState()),
    moves: () => console.table(game.getMoves()),
    forbidden: (x, y) => game.checkForbidden(x, y),
    aiHint: () => game.getHintMove()
};
```

**常用调试命令**:
```javascript
GameDebug.board();                // 查看棋盘
GameDebug.forbidden(7, 7);        // 检查禁手
GameDebug.aiHint();               // 获取AI建议
boardRenderer.highlightHintPosition(7, 7); // 手动画提示
```

---

**如仍无法解决**:
1. 检查控制台错误
2. 查阅 [08_测试与部署指南](./08_测试与部署指南.md)
3. 查看源代码 (js/*.js)
4. 提交Issue描述问题和复现步骤
